<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Chat de consultas geogr√°ficas ‚Äì flujo tipo √°rbol</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root{
      --bg:#06150f; --panel:#0b2018; --ink:#e6f4ef; --muted:#9bb3a9; --accent:#0a784f; --accent-ink:#0a5e41;
      --chip:#103524; --border:#153c2a; --warn:#eab308; --err:#ef4444; --ok:#17c964;
    }
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;}

    header{border-bottom:1px solid var(--border); background:linear-gradient(180deg, rgba(10,120,79,.18), rgba(10,120,79,0));}
    .wrap{max-width:960px; margin:0 auto; padding:14px 16px}
    h1{margin:0; font-size:clamp(18px, 4vw, 22px)}
    .tag{color:var(--muted); font-size:13px}

    .main{display:grid; grid-template-columns:1fr; gap:14px; padding:12px 0}

    /* Chat */
    .chat{max-width:960px; margin:0 auto; display:grid; gap:12px; padding:0 16px 64px}
    .msg{display:flex; gap:10px}
    .msg.bot{justify-content:flex-start}
    .msg.user{justify-content:flex-end}
    .bubble{background:var(--panel); border:1px solid var(--border); padding:12px 14px; border-radius:14px; max-width:min(720px, 84vw)}
    .bubble.bot{border-top-left-radius:6px}
    .bubble.user{background:#0a5e41; border-color:transparent; border-bottom-right-radius:6px}
    .opts{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px}
    .opt{appearance:none; background:var(--accent); border:none; color:#fff; padding:8px 12px; border-radius:999px; cursor:pointer; font-weight:600}
    .opt.secondary{background:transparent; color:#d1efe4; border:1px solid var(--border)}
    .inline{display:flex; gap:8px; margin-top:8px}
    .inline input{flex:1; min-width:0; padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:#08170f; color:var(--ink)}
    .inline button{padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:var(--accent); color:#fff; cursor:pointer}
    .small{font-size:12px; color:var(--muted)}

    /* Mapa */
    .map-wrap{max-width:1100px; margin:0 auto; padding:0 16px 22px; display:none}
    .map-tools{display:flex; align-items:center; gap:10px; margin:10px 0; flex-wrap:wrap}
    .btn{background:transparent; border:1px solid var(--border); color:#d7eee6; padding:8px 10px; border-radius:10px; font-size:13px; text-decoration:none; cursor:pointer}
    .btn.primary{background:var(--accent-ink); color:white; border-color:transparent}
    #map{height:58vh; border:1px solid var(--border); border-radius:14px}

    details{background:#0b2418; border:1px solid var(--border); border-radius:12px; padding:8px 10px; margin:8px 0}
    details>summary{cursor:pointer; font-weight:600}
    table{width:100%; border-collapse:collapse; margin-top:6px; font-size:13px}
    td{border-top:1px dashed var(--border); padding:6px; vertical-align:top}
    td:first-child{color:#b7d1c7; width:40%}
    .error{background:#230b0b; border:1px solid #501c1c; color:#ffdddd; padding:10px 12px; border-radius:12px}

    /* FAB global */
    .refresh-fab{position:fixed; right:16px; bottom:16px; z-index:9999}
    .refresh-fab button{background:#0a5e41; color:#fff; border:none; border-radius:999px; padding:10px 14px; box-shadow:0 6px 18px rgba(0,0,0,.35); cursor:pointer; font-weight:700}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Consultas geogr√°ficas (chat por opciones)</h1>
      <div class="tag">Flujo tipo √°rbol: si cambias arriba, se poda lo de abajo. Solo categor√≠as con REST o respaldo.</div>
    </div>
  </header>

  <main class="main">
    <section id="chat" class="chat" aria-live="polite"></section>

    <section id="mapWrap" class="map-wrap" aria-label="Resultados y mapa">
      <div class="map-tools">
        <button class="btn" id="btnBackToPoint">‚ü≤ Volver a elegir punto</button>
        <button class="btn" id="btnBackToCategory">‚ü≤ Cambiar categor√≠a</button>
        <button class="btn" id="btnRefresh">Refrescar consulta</button>
        <span class="small" id="mapStatus">‚Äî</span>
      </div>
      <div id="map" role="application" aria-label="Mapa"></div>
      <div id="results" style="margin-top:10px"></div>
    </section>
  </main>

  <div class="refresh-fab"><button id="fabRefresh">‚ü≥ Refrescar chat</button></div>

<script>
/* ===== Config ===== */
const CSV_URL = 'https://docs.google.com/spreadsheets/d/1Smop4rx0K4pj5sHXD19DE3iqcwTCyqn9ohPxIuJsZ8s/export?format=csv&gid=0';
const CO_VIEWBOX = '-79.1,12.6,-66.8,-4.3';

/* ===== Estado global (para rebobinar ramas) ===== */
const STATE = {
  catalog: [],
  categories: [],
  step: 0,               // 0: m√©todo de punto; 1: punto fijado; 2: categor√≠a; 3: resultados
  point: null,           // {lat,lng}
  category: null,
  map: null,
  marker: null,
  drawn: {},             // id -> L.GeoJSON
};

/* ===== Helpers UI ===== */
const byId = id => document.getElementById(id);
const chatEl = byId('chat');
function el(tag, attrs={}, html=''){ const n=document.createElement(tag); Object.assign(n, attrs); if(html!==undefined) n.innerHTML=html; return n; }
function scrollChat(){ chatEl.scrollTop = chatEl.scrollHeight; }
function addBot(html){ const row=el('div',{className:'msg bot'}); row.appendChild(el('div',{className:'bubble bot'}, html)); chatEl.appendChild(row); scrollChat(); return row; }
function addUser(html){ const row=el('div',{className:'msg user'}); row.appendChild(el('div',{className:'bubble user'}, html)); chatEl.appendChild(row); scrollChat(); }
function clearChat(){ chatEl.innerHTML=''; }

/* ===== Normalizaci√≥n del cat√°logo ===== */
const deaccent = s => (s||'').normalize('NFD').replace(/\p{Diacritic}/gu,'');
function normalizeRecord(rec){
  const out={};
  for(const [k,v] of Object.entries(rec)){
    const key = deaccent(String(k).trim().toLowerCase()).replace(/\s+/g,'_').replace(/[^a-z0-9_]/g,'');
    out[key] = (v==null) ? '' : String(v).trim();
  }
  out.titulo = out.titulo || out.title || '';
  out.descripcion = out.descripcion || out.description || '';
  out.categoria = out.categoria || out.categoria_ || out['categor_a'] || '';
  out.rest = out.rest || '';
  out.rest_respaldo = out['rest_de_respaldo'] || out['rest_respaldo'] || '';
  out.origen = out.origen || out.fuente || '';
  return out;
}

async function loadCatalog(){
  return new Promise((resolve,reject)=>{
    Papa.parse(CSV_URL,{download:true, header:true, skipEmptyLines:true,
      complete:(res)=>{ try{ STATE.catalog = res.data.map(normalizeRecord); resolve(STATE.catalog);}catch(e){reject(e)} },
      error:(e)=>reject(e)
    });
  });
}

function computeCategories(){
  const ok = STATE.catalog.filter(r=> (r.rest && r.rest.length>6) || (r.rest_respaldo && r.rest_respaldo.length>6));
  const set = new Set(ok.map(r=>r.categoria).filter(Boolean));
  STATE.categories = Array.from(set).sort((a,b)=>a.localeCompare(b,'es',{sensitivity:'base'}));
}

/* ===== Mapa ===== */
function ensureMap(){
  const wrap = byId('mapWrap');
  wrap.style.display='block';
  if(STATE.map) return STATE.map;
  STATE.map = L.map('map',{zoomControl:true, minZoom:3}).setView([3.9,-73.1], 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'&copy; OpenStreetMap contrib.'}).addTo(STATE.map);
  return STATE.map;
}

function setMarker(ll){
  ensureMap();
  if(STATE.marker){ STATE.map.removeLayer(STATE.marker); }
  STATE.marker = L.marker(ll).addTo(STATE.map);
  STATE.map.setView(ll, 12);
}

function clearDrawn(){
  Object.values(STATE.drawn).forEach(layer=>{ if(STATE.map && STATE.map.hasLayer(layer)) STATE.map.removeLayer(layer); });
  STATE.drawn = {};
}

/* ===== Flujo tipo √°rbol (rebobinar seg√∫n step) ===== */
function goToStep(step){
  STATE.step = step;
  clearChat(); // siempre re-render desde el inicio hasta el step actual
  if(step===0) renderStep0();
  if(step>=1){ renderStep0(true); renderStep1(); }
  if(step>=2){ renderStep2(); }
  if(step>=3){ renderStep3(); }
}

function renderStep0(skipIntro=false){
  if(!skipIntro){ addBot('<b>Hola.</b> Primero, ¬øen qu√© punto quieres consultar?'); }
  const row = addBot('Elige una opci√≥n:');
  const opts = el('div',{className:'opts'});
  const b1 = el('button',{className:'opt'},'üìç Usar mi ubicaci√≥n');
  const b2 = el('button',{className:'opt secondary'},'‚ûï Elegir otro punto');
  opts.append(b1,b2); row.querySelector('.bubble').appendChild(opts);
  b1.onclick = handleUseMyLocation;
  b2.onclick = handleChooseOther;
}

function renderStep1(){
  if(!STATE.point){ return; }
  addUser(`Ubicaci√≥n establecida: ${STATE.point.lat.toFixed(5)}, ${STATE.point.lng.toFixed(5)}`);
  setMarker(STATE.point);
}

function renderStep2(){
  const available = STATE.categories.slice();
  if(!available.length){ addBot('<span class="error">No hay categor√≠as con REST disponible en la tabla.</span>'); return; }
  const row = addBot('¬øQu√© tipo de consulta quieres hacer?');
  const opts = el('div',{className:'opts'});
  available.forEach(cat=>{
    const b = el('button',{className:'opt'}, cat);
    b.onclick = ()=>{ STATE.category = cat; addUser(cat); goToStep(3); runQuery(); };
    opts.appendChild(b);
  });
  row.querySelector('.bubble').appendChild(opts);
}

function renderStep3(){
  ensureMap();
  byId('mapStatus').textContent = 'Consultando‚Ä¶';
}

/* ===== Interacciones del punto ===== */
function handleUseMyLocation(){
  addUser('Usar mi ubicaci√≥n');
  if(!navigator.geolocation){ addBot('<span class="error">Tu navegador no permite geolocalizaci√≥n.</span>'); return; }
  addBot('Obteniendo tu ubicaci√≥n‚Ä¶');
  navigator.geolocation.getCurrentPosition((pos)=>{
    STATE.point = {lat:pos.coords.latitude, lng:pos.coords.longitude};
    goToStep(1); renderStep2();
  }, (err)=>{ addBot(`<span class=\"error\">No se pudo obtener ubicaci√≥n: ${err.message}</span>`); });
}

function handleChooseOther(){
  addUser('Elegir otro punto');
  const row = addBot('¬øC√≥mo quieres fijar el punto?');
  const opts = el('div',{className:'opts'});
  const b1 = el('button',{className:'opt'},'üîé Buscar con OSM');
  const b2 = el('button',{className:'opt'},'üó∫Ô∏è Marcar en mapa');
  opts.append(b1,b2); row.querySelector('.bubble').appendChild(opts);
  b1.onclick = () => askSearch();
  b2.onclick = () => pickOnMap();
}

function askSearch(){
  const row = addBot('Escribe un lugar o direcci√≥n (Colombia).');
  const box = el('div',{className:'inline'});
  const inp = el('input',{type:'text', placeholder:'Cra 7 # 12-34, Bogot√°‚Ä¶ o ‚ÄúParque Arv√≠‚Äù'});
  const btn = el('button',{},'Buscar');
  box.append(inp,btn); row.querySelector('.bubble').appendChild(box);
  btn.onclick=()=> doOSMSearch(inp.value);
  inp.addEventListener('keydown',(e)=>{ if(e.key==='Enter') doOSMSearch(inp.value); });
}

async function doOSMSearch(q){
  const text = (q||'').trim(); if(!text) return;
  addUser(text);
  try{
    const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&q=${encodeURIComponent(text)}&addressdetails=1&limit=5&countrycodes=co&viewbox=${CO_VIEWBOX}&bounded=1`;
    const res = await fetch(url, {headers:{'Accept':'application/json'}});
    if(!res.ok) throw new Error('Sin respuesta de Nominatim');
    const items = await res.json();
    if(!items.length){ addBot('Sin resultados en Colombia para esa b√∫squeda.'); return; }
    if(items.length===1){
      const it = items[0];
      STATE.point = {lat:parseFloat(it.lat), lng:parseFloat(it.lon)};
      goToStep(1); renderStep2();
    } else {
      const row = addBot('Selecciona el resultado correcto:');
      const opts = el('div',{className:'opts'});
      items.forEach(it=>{
        const b = el('button',{className:'opt secondary'}, it.display_name.slice(0,64)+'‚Ä¶');
        b.onclick = ()=>{ STATE.point = {lat:parseFloat(it.lat), lng:parseFloat(it.lon)}; goToStep(1); renderStep2(); };
        opts.appendChild(b);
      });
      row.querySelector('.bubble').appendChild(opts);
    }
  }catch(e){ addBot(`<span class=\"error\">Error buscando: ${e.message}</span>`); }
}

function pickOnMap(){
  ensureMap();
  addBot('Haz clic en el mapa para fijar/actualizar el punto.');
  const handler = (e)=>{ STATE.point = {lat:e.latlng.lat, lng:e.latlng.lng}; setMarker(STATE.point); goToStep(1); renderStep2(); };
  STATE.map.once('click', handler);
}

/* ===== REST: robustecer consultas ===== */
function urlWithParams(base, params){
  const u = new URL(base);
  Object.entries(params).forEach(([k,v])=> u.searchParams.set(k,String(v)));
  return u.toString();
}

async function fetchJson(u, extra={}){
  const url = u.includes('?') ? `${u}&f=json` : `${u}?f=json`;
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort('timeout'), 10000);
  try{
    const res = await fetch(url, {signal:ctrl.signal, ...extra});
    clearTimeout(t);
    if(!res.ok) throw new Error('HTTP '+res.status);
    return await res.json();
  }catch(e){ clearTimeout(t); return {error:String(e)}; }
}

function isMapServerRoot(info){ return info && info.currentVersion && Array.isArray(info.layers) && !info.type; }

async function expandToFeatureLayers(url){
  const info = await fetchJson(url);
  if(info.error) return {error:info.error, layers:[]};
  if(isMapServerRoot(info)){
    const layers = (info.layers||[]).filter(l=> !l.subLayerIds || !l.subLayerIds.length);
    return {layers: layers.map(l=> `${url.replace(/\/?$/,'')}/${l.id}`)};
  }
  return {layers:[url]};
}

async function queryLayerAtPoint(layerUrl, point){
  const info = await fetchJson(layerUrl);
  if(info.error) return {error:'Servicio no disponible', layerUrl};

  const base = {
    where: '1=1', f:'json', returnGeometry:false, outFields:'*',
    geometry: JSON.stringify({x:point.lng, y:point.lat, spatialReference:{wkid:4326}}),
    geometryType: 'esriGeometryPoint', spatialRel:'esriSpatialRelIntersects',
    inSR:4326, outSR:4326
  };

  async function runOnce(params){
    const queryUrl = layerUrl.replace(/\/?$/,'') + '/query';
    const u = urlWithParams(queryUrl, params);
    const js = await fetchJson(u);
    if(js.error || js.code){ return {error: js.error? String(js.error): ('HTTP '+js.code)}; }
    const feats = Array.isArray(js.features)? js.features: [];
    return {features:feats};
  }

  let res = await runOnce(base);
  if(res.error) return {error:res.error, layerUrl};
  if(res.features && res.features.length) return {features:res.features, strategy:'point'};

  res = await runOnce({...base, distance:50, units:'esriSRUnit_Meter'});
  if(res.error) return {error:res.error, layerUrl};
  if(res.features && res.features.length) return {features:res.features, strategy:'near50m'};

  res = await runOnce({...base, distance:250, units:'esriSRUnit_Meter'});
  if(res.error) return {error:res.error, layerUrl};
  if(res.features && res.features.length) return {features:res.features, strategy:'near250m'};

  return {features:[], strategy:'none'};
}

function getDefsForCategory(cat){
  const rows = STATE.catalog.filter(r=> r.categoria===cat && ((r.rest && r.rest.length>6) || (r.rest_respaldo && r.rest_respaldo.length>6)));
  return rows.map((r,i)=> ({ id:`${deaccent(cat.toLowerCase()).replace(/[^a-z0-9]/g,'_')}_${i}`, name:r.titulo||r.descripcion||r.origen||`Capa ${i+1}`, primary:r.rest, backup:r.rest_respaldo }));
}

async function runQuery(){
  if(!STATE.point || !STATE.category){ addBot('<span class="error">Faltan datos para consultar (punto y categor√≠a).</span>'); return; }
  clearDrawn();
  const defs = getDefsForCategory(STATE.category);
  if(!defs.length){ addBot('<span class="error">No hay capas con REST en esta categor√≠a.</span>'); return; }

  addBot('Consultando servicios de la categor√≠a seleccionada‚Ä¶');
  const results = [];
  for(const def of defs){
    // Intentar servicio primario; si falla, usar respaldo
    let r = await queryLayerAtPoint(def.primary, STATE.point);
    let usedBackup = false;
    if(r.error && def.backup){ usedBackup = true; r = await queryLayerAtPoint(def.backup, STATE.point); }
    results.push({def, usedBackup, ...r});
  }
  presentResults(results);
}

function presentResults(results){
  ensureMap();
  const resEl = byId('results');
  resEl.innerHTML = '';

  const found = results.filter(r=> (r.features||[]).length>0);
  const down = results.filter(r=> r.error);
  const zero = results.filter(r=> !r.error && (!r.features || !r.features.length));

  const msg = [];
  if(found.length){ msg.push(`Se encontraron <b>${found.length}</b> capa(s) con coincidencias en el punto.`); }
  if(zero.length){ msg.push(`<span class=\"small\">${zero.length} capa(s) respondieron sin intersecciones tras probar distintas estrategias.</span>`); }
  if(down.length){ msg.push(`<span class=\"small\" style=\"color:#f7d38b\">${down.length} capa(s) no disponibles actualmente (problema de la fuente oficial). No se marcan como \"sin intersecci√≥n\".</span>`); }
  addBot(msg.join('<br>'));

  const summaryHits=[];
  results.forEach(({def, features, error, usedBackup, strategy}, idx)=>{
    const title = def.name || `Capa ${idx+1}`;
    if(error){ resEl.appendChild(el('div',{}, `<span class=\"small\">${title}: <span style=\"color:var(--warn)\">Capa no disponible (error de servicio)</span></span>`)); return; }
    const count = (features||[]).length;
    const details = el('details');
    details.innerHTML = `<summary>${title} <span class=\"small\">(${count} resultado/s${usedBackup?' ‚Äì usando respaldo':''}${strategy&&strategy!=='point'?` ‚Äì estrategia: ${strategy}`:''})</span></summary>`;

    (features||[]).forEach((ft,i)=>{
      const attrs = ft.attributes || ft.properties || {};
      const tbl = el('table');
      Object.keys(attrs).forEach(k=>{
        const tr = el('tr'); tr.appendChild(el('td',{}, k)); tr.appendChild(el('td',{}, String(attrs[k]))); tbl.appendChild(tr);
      });
      const wrap = el('div',{});
      wrap.innerHTML = `<div class=\"small\" style=\"margin-top:6px\">#${i+1}</div>`; wrap.appendChild(tbl); details.appendChild(wrap);
    });
    resEl.appendChild(details);

    try{
      if(count){ summaryHits.push(`${title}: ${count}`); }
      const gj = L.geoJSON((features||[]).map(f=>({type:'Feature', properties:f.attributes||f.properties||{}, geometry:f.geometry||null})), {
        style:()=>({color:'#0a784f', weight:1.1, fillColor:'#0a784f', fillOpacity:.35})
      });
      gj.addTo(STATE.map); STATE.drawn[def.id] = gj;
    }catch{}
  });

  byId('mapStatus').textContent = summaryHits.length? `Capas con resultados ‚Üí ${summaryHits.join(' | ')}` : 'Sin intersecciones.';
}

/* ===== Botones persistentes ===== */
function wireButtons(){
  byId('btnRefresh').onclick = ()=>{ if(STATE.point && STATE.category) runQuery(); };
  byId('btnBackToPoint').onclick = ()=>{ STATE.category=null; goToStep(0); };
  byId('btnBackToCategory').onclick = ()=>{ if(STATE.point){ STATE.category=null; goToStep(2);} else { goToStep(0);} };
  byId('fabRefresh').onclick = ()=> restartAll();
}

function restartAll(){
  clearChat();
  byId('results').innerHTML='';
  byId('mapStatus').textContent='‚Äî';
  if(STATE.marker && STATE.map){ STATE.map.removeLayer(STATE.marker); STATE.marker=null; }
  clearDrawn();
  STATE.step=0; STATE.point=null; STATE.category=null;
  goToStep(0);
}

/* ===== Init ===== */
(async function init(){
  try{
    await loadCatalog();
    computeCategories();
    addBot('Se carg√≥ la tabla p√∫blica con variables y fuentes. Solo se ofrecer√°n categor√≠as con REST/Respaldo disponible.');
    wireButtons();
    goToStep(0);
  }catch(e){
    addBot(`<div class=\"error\">Error al cargar la tabla de variables: ${e.message}. Intenta recargar.</div>`);
  }
})();
</script>
</body>
</html>
